name: Autograding Tests
'on':
- push
- repository_dispatch
permissions:
  checks: write
  actions: read
  contents: read
jobs:
  run-autograding-tests:
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Build project
      run: npm run build

    - name: Copy data.json to dist
      run: cp data.json dist/data.json

    - name: Start preview server
      run: npm run preview >/dev/null 2>&1 & sleep 5

    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Install Playwright
      run: npx playwright install chromium

    # Basic checks
    - name: Page loads with 200
      id: page-loads-with-200
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Page loads with 200
        setup-command: ''
        command: curl -s -o /dev/null -w "%{http_code}" http://localhost:4173
        input: ''
        expected-output: '200'
        comparison-method: exact
        timeout: 2
        max-score: 5

    - name: Data file exists and is valid
      id: data-file-exists-and-is-valid
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Data file exists and is valid
        setup-command: ''
        command: curl -s http://localhost:4173/data.json | jq '.products | length'
        input: ''
        expected-output: '20'
        comparison-method: exact
        timeout: 2
        max-score: 5

    # DOM structure checks
    - name: Has products grid element
      id: has-products-grid-element
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Has products grid element
        setup-command: ''
        command: node tests/autograding-tests.js has-products-grid
        input: ''
        expected-output: 'true'
        comparison-method: exact
        timeout: 10
        max-score: 5

    - name: Has search input
      id: has-search-input
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Has search input
        setup-command: ''
        command: node tests/autograding-tests.js has-search-input
        input: ''
        expected-output: 'true'
        comparison-method: exact
        timeout: 10
        max-score: 5

    - name: Has filter dropdowns
      id: has-filter-dropdowns
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Has filter dropdowns
        setup-command: ''
        command: node tests/autograding-tests.js has-filter-dropdowns
        input: ''
        expected-output: 'true'
        comparison-method: exact
        timeout: 10
        max-score: 5

    # Functionality checks
    - name: Products load and display
      id: products-load-and-display
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Products load and display
        setup-command: ''
        command: node tests/autograding-tests.js products-load-and-display
        input: ''
        expected-output: 'true'
        comparison-method: exact
        timeout: 10
        max-score: 10

    - name: Search filters products
      id: search-filters-products
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Search filters products
        setup-command: ''
        command: node tests/autograding-tests.js search-filters-products
        input: ''
        expected-output: 'true'
        comparison-method: exact
        timeout: 10
        max-score: 15

    - name: Category filter works
      id: category-filter-works
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Category filter works
        setup-command: ''
        command: node tests/autograding-tests.js category-filter-works
        input: ''
        expected-output: 'true'
        comparison-method: exact
        timeout: 10
        max-score: 15

    - name: Price sorting works
      id: price-sorting-works
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Price sorting works
        setup-command: ''
        command: node tests/autograding-tests.js price-sorting-works
        input: ''
        expected-output: 'true'
        comparison-method: exact
        timeout: 10
        max-score: 10

    # Accessibility checks
    - name: Page has lang attribute
      id: page-has-lang-attribute
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Page has lang attribute
        setup-command: ''
        command: curl -s http://localhost:4173 | grep -c '<html lang='
        input: ''
        expected-output: '1'
        comparison-method: exact
        timeout: 2
        max-score: 5

    - name: Has semantic HTML
      id: has-semantic-html
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Has semantic HTML
        setup-command: ''
        command: |
          CONTENT=$(curl -s http://localhost:4173)
          HEADER=$(echo "$CONTENT" | grep -c '<header>' || echo 0)
          MAIN=$(echo "$CONTENT" | grep -c '<main ' || echo 0)
          echo $(($HEADER + $MAIN))
        input: ''
        expected-output: '2'
        comparison-method: exact
        timeout: 2
        max-score: 5

    - name: No console errors
      id: no-console-errors
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: No console errors
        setup-command: ''
        command: node tests/autograding-tests.js no-console-errors
        input: ''
        expected-output: 'true'
        comparison-method: exact
        timeout: 10
        max-score: 10

    - name: Autograding Reporter
      uses: classroom-resources/autograding-grading-reporter@v1
      env:
        PAGE-LOADS-WITH-200_RESULTS: "${{steps.page-loads-with-200.outputs.result}}"
        DATA-FILE-EXISTS-AND-IS-VALID_RESULTS: "${{steps.data-file-exists-and-is-valid.outputs.result}}"
        HAS-PRODUCTS-GRID-ELEMENT_RESULTS: "${{steps.has-products-grid-element.outputs.result}}"
        HAS-SEARCH-INPUT_RESULTS: "${{steps.has-search-input.outputs.result}}"
        HAS-FILTER-DROPDOWNS_RESULTS: "${{steps.has-filter-dropdowns.outputs.result}}"
        PRODUCTS-LOAD-AND-DISPLAY_RESULTS: "${{steps.products-load-and-display.outputs.result}}"
        SEARCH-FILTERS-PRODUCTS_RESULTS: "${{steps.search-filters-products.outputs.result}}"
        CATEGORY-FILTER-WORKS_RESULTS: "${{steps.category-filter-works.outputs.result}}"
        PRICE-SORTING-WORKS_RESULTS: "${{steps.price-sorting-works.outputs.result}}"
        PAGE-HAS-LANG-ATTRIBUTE_RESULTS: "${{steps.page-has-lang-attribute.outputs.result}}"
        HAS-SEMANTIC-HTML_RESULTS: "${{steps.has-semantic-html.outputs.result}}"
        NO-CONSOLE-ERRORS_RESULTS: "${{steps.no-console-errors.outputs.result}}"
      with:
        runners: page-loads-with-200,data-file-exists-and-is-valid,has-products-grid-element,has-search-input,has-filter-dropdowns,products-load-and-display,search-filters-products,category-filter-works,price-sorting-works,page-has-lang-attribute,has-semantic-html,no-console-errors
